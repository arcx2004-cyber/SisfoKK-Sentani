name: Deploy to Alpine Server

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            # Masuk ke direktori project (sesuaikan path jika berbeda)
            cd ~/SisfoKK-Sentani
            
            # Matikan container lama (opsional, untuk safety)
            # docker compose down
            
            # Pull source code terbaru
            git pull origin main
            
            # Build ulang & nyalakan container (hanya yang berubah)
            docker compose up -d --build --remove-orphans
            
            # Tunggu sebentar agar database ready
            sleep 10
            
            # Bersihkan cache Laravel
            docker compose exec -T php php artisan optimize:clear
            
            # Jalankan migrasi database (force untuk production)
            docker compose exec -T php php artisan migrate --force
            
            # Bersihkan compiled assets/views
            docker compose exec -T php php artisan view:cache
            docker compose exec -T php php artisan config:cache
            
            # Update permissions (if needed)
            docker compose exec -T php chmod -R 777 storage bootstrap/cache
            
            echo "Deployment finished successfully!"
